<!DOCTYPE html>
<html>
<head>
    <title>MMR Trend Chart</title>
    <link rel="stylesheet" href="/style.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <!-- Navbar -->
    <%- include('partials/navbar.html', { page: 'trend' }) %>

    <div class="page-container">

        <h2>MMR Trend Chart</h2>

        <!-- Form Card -->
        <div class="form-card">
            <form id="trendForm">

                <label for="country_id">Select Country:</label>
                <select id="country_id" required>
                    <% countries.forEach(c => { %>
                        <option value="<%= c.country_id %>"><%= c.name %></option>
                    <% }) %>
                </select>

                <!-- Year Range -->
                <label>Year Range:</label>

                <div class="slider-row">
                    <input type="range" id="startYear" min="1990" max="2025" value="2000">
                    <span id="startLabel" class="slider-label">2000</span>
                </div>

                <div class="slider-row">
                    <input type="range" id="endYear" min="1990" max="2025" value="2020">
                    <span id="endLabel" class="slider-label">2020</span>
                </div>

                <button type="submit" class="btn-primary">Show Trend</button>
            </form>
        </div>

        <!-- Chart Container -->
        <div class="chart-card">
            <canvas id="trendChart"></canvas>
        </div>

        <a href="/" class="back-link">‚Üê Back to Dashboard</a>
    </div>


    <!-- JS Logic -->
    <script>
        let chart;

        const startSlider = document.getElementById("startYear");
        const endSlider = document.getElementById("endYear");
        const startLabel = document.getElementById("startLabel");
        const endLabel = document.getElementById("endLabel");

        startSlider.oninput = () => startLabel.innerText = startSlider.value;
        endSlider.oninput = () => endLabel.innerText = endSlider.value;

        document.getElementById("trendForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const countryId = document.getElementById("country_id").value;
            const startYear = parseInt(startSlider.value);
            const endYear = parseInt(endSlider.value);

            const res = await fetch(`/trend-data?country_id=${countryId}`);
            const raw = await res.json();

            const data = raw.filter(r => r.year >= startYear && r.year <= endYear);

            const years = data.map(r => r.year);
            const mmrs = data.map(r => r.mmr);

            const ctx = document.getElementById("trendChart").getContext("2d");

            if (chart) chart.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, "rgba(140,120,81,0.4)");
            gradient.addColorStop(1, "rgba(140,120,81,0.05)");

            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: years,
                    datasets: [{
                        label: "MMR Trend",
                        data: mmrs,
                        fill: true,
                        backgroundColor: gradient,
                        borderColor: "#8c7851",
                        borderWidth: 3,
                        tension: 0.35,
                        pointBackgroundColor: "#fff",
                        pointRadius: 5,
                        pointHoverRadius: 10,
                        pointHoverBackgroundColor: "#8c7851"
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { font: { size: 14 } } },
                        tooltip: {
                            backgroundColor: "#8c7851",
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 }
                        }
                    },
                    scales: {
                        y: { ticks: { font: { size: 13 } } },
                        x: { ticks: { font: { size: 13 } } }
                    }
                }
            });
        });
    </script>

</body>
</html>
